<div class="modal-header">
    <div class="modal-title">
        <h4>Nueva Factura</h4>
    </div>
</div>
<div class="fixed-top m-3 text-right">
    <div ngbDropdown #setDrop="ngbDropdown">
        <button class="btn btn-link" id="dropdownSettings" ngbDropdownToggle><i class="fa-solid fa-gear"></i></button>
        <div ngbDropdownMenu class="dropdown-menu-right dropdown-black" aria-labelledby="dropdownSettings">
            <form (submit)="editSettings(settingsForm.value)" #settingsForm="ngForm" class="px-4 py-3">
                <div class="form-group">
                    <label for="printerAddress" class="text-light">Servidor EscPos</label>
                    <input id="printerAddress" name="printerAddress" type="text" class="form-control" [ngModel]="ipEscPos" pattern="(http)s?:\/\/(((([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]))|localhost):[0-9]+"
                        required>
                </div>
                <div class="form-group">
                    <label for="printerName" class="text-light">Id Impresora</label>
                    <input id="printerName" name="printerName" type="text" class="form-control" [ngModel]="nameEscPos" required>
                </div>
                <div class="text-right">
                    <button type="submit" (click)="setDrop.close()" [disabled]="settingsForm.invalid||settingsForm.pristine" class="btn btn-simple btn-danger btn-sm ">Guardar</button>
                </div>
            </form>
        </div>
        <button type="button" class="btn-close btn btn-link p-0" aria-label="Close" (click)="activeModal.dismiss('Cross click')">X</button>
    </div>
</div>
<div class="modal-body">
    <div class="row g-5">
        <div class="col-12">
            <div class="card mb-3">
                <div class="card-header">
                    <h4 class="mb-3">Datos de cliente</h4>
                    <div class="input-group">
                        <input class="form-control py-2 border-right-0" type="search" placeholder="Buscar cliente" [(ngModel)]="model" (ngModelChange)="updateForm($event)" [inputFormatter]="formatter" [class.is-invalid]="searchFailed" [ngbTypeahead]="search" [resultFormatter]="formatter"
                            id="example-search-input">
                        <span class="input-group-append" style="top: 0; left:0;">
                        <div class="input-group-text bg-transparent"><i class="fa fa-search"></i></div>
                    </span>
                        <div class="invalid-feedback">
                            Ocurrió un error
                        </div>
                    </div>
                    <small *ngIf="searching" class="form-text text-muted">buscando...</small>
                </div>
                <div class="card-body pt-0">
                    <form [formGroup]="clientForm" class="needs-validation" [ngClass]="{'was-validated':clientForm.invalid&&clientForm.touched}">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="voucher_type" class="form-label">Tipo de factura</label>
                                <select class="form-control mb-2" id="voucher_type" formControlName="voucher_type" required>
                                        <option hidden selected disabled value="">Seleccione un tipo</option>
                                        <option [value]="item.Id" *ngFor="let item of voucherTypes">{{item.Desc}}</option>
                                    </select>
                                <div class="invalid-feedback">
                                    Debes seleccionar un tipo de factura
                                </div>
                            </div>
                            <div class="col">
                                <button type="button" class="btn btn-link btn-block btn-neutral p-0" (click)="collapse.toggle()" [attr.aria-expanded]="!isCollapsed" aria-controls="collapseExample"><i class="fa-solid fa-angle-down" [ngClass]="{'fa-angle-down':isCollapsed,'fa-angle-up':!isCollapsed}"></i>Ver detalle</button>
                            </div>
                            <div #collapse="ngbCollapse" [(ngbCollapse)]="isCollapsed">
                                <div class="col-12">
                                    <label for="identifier" class="form-label">DNI/CUIT</label>
                                    <div class="input-group has-validation">
                                        <select class="form-control col-4" formControlName="id_type" required>
                                        <option hidden selected disabled value="">Tipo</option>
                                        <option [value]="item.Id" *ngFor="let item of documentTypes">{{item.Desc}}</option>
                                    </select>
                                        <input type="text" class="form-control" id="identifier" (blur)="getClientbyID()" placeholder="" formControlName="identifier" required>
                                        <div class="invalid-feedback">
                                            Campo requerido
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="user_name" class="form-label">Nombre </label>
                                    <input type="text" class="form-control" id="user_name" placeholder="" value="" formControlName="user_name">
                                </div>

                                <div class="col-12">
                                    <label for="business_name" class="form-label">Razón social</label>
                                    <input type="text" class="form-control" id="business_name" placeholder="" value="" formControlName="business_name">
                                    <div class="invalid-feedback">
                                        Valid last name is required.
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="person" class="form-label">Persona</label>
                                    <select class="form-control" id="person" formControlName="person" required>
                                            <option selected hidden disabled value="">Seleccione una opción</option>
                                            <option value="FISICA">FISICA</option>
                                            <option value="JURIDICA">JURIDICA</option>
                                        </select>
                                    <div class="invalid-feedback">
                                        Debes seleccionar una persona válida
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label for="tax_address" class="form-label">Dirección fiscal</label>
                                    <input type="text" class="form-control" id="tax_address" placeholder="1234 Main St" formControlName="tax_address" required>
                                    <div class="invalid-feedback">
                                        Debe ingresar al menos una dirección válida
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="phone" class="form-label">Teléfono <span class="text-muted">(Opcional)</span></label>
                                    <input type="text" class="form-control" id="phone" placeholder="0-123-8888" formControlName="phone">
                                </div>
                                <div class="col-12">
                                    <label for="email" class="form-label">Email <span class="text-muted">(Opcional)</span></label>
                                    <input type="email" class="form-control" id="email" placeholder="you@example.com" formControlName="email">
                                    <div class="invalid-feedback">
                                        Ingrese un email válido
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- <button class="w-100 btn btn-primary btn-lg" type="submit">Continue to checkout</button> -->
                    </form>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span>Venta</span>
                        <span class="badge bg-primary rounded-pill">{{totals.n}}</span>
                    </h4>
                </div>
                <div class="card-body">
                    <h5>
                        <span>Nuevo ítem:</span> </h5>
                    <span>
                        <div class="input-group">
                            <input
                            class="form-control py-2 border-right-0"
                            type="search"
                            placeholder="Buscar producto"
                            [(ngModel)]="pSelected"
                            [ngbTypeahead]="pSearch"
                            [inputFormatter]="pFormatter"
                            [resultFormatter]="pFormatter"
                            (focus)="focus$.next($any($event).target.value)"
                            (click)="click$.next($any($event).target.value)"
                            #instance="ngbTypeahead"
                            />
                            <span class="input-group-append" style="top: 0; left:0;">
                            <div class="input-group-text bg-transparent"><i class="fa fa-search"></i>
                            </div>
                            </span>
                </div>
                </span>
                <form [formGroup]="newItemForm" (submit)="addItem()" class="needs-validation" [ngClass]="{'was-validated':newItemForm.invalid&&(newItemForm.touched)}">
                    <div class="row g-3 justify-content-center">
                        <div class="col-5">
                            <label for="quantity" class="form-label">Cantidad:</label>
                            <input type="number" inputmode="numeric" class="form-control" id="quantity" placeholder="" formControlName="quantity" required>
                        </div>
                        <div class="col-7">
                            <label for="subtotal" class="form-label">Subtotal:</label>
                            <input type="number" inputmode="numeric" class="form-control" id="subtotal" placeholder="" formControlName="subtotal" required>
                        </div>
                        <div class="col-12" class="justify-content-center">
                            <button class="btn btn-link btn-success pb-3" type="submit" [disabled]="newItemForm.invalid||!pSelected"><i class="fa-solid fa-circle-plus"></i> Agregar</button>
                        </div>
                    </div>
                </form>

                <ul class="list-group mb-3">
                    <li *ngFor="let item of items; index as i; last as isLast" class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0 text-dark">#{{i+1}} {{item.description}}</h6>
                            <small class="text-muted">{{item.quantity|number:'1.0-2'}}x{{item.unit_price|currency:"ARS"}}</small>
                        </div>
                        <span class="text-muted font-weight-bold align-self-center">{{item.subtotal|currency:'ARS'}}</span>
                        <span>
                                <div class="d-flex flex-column justify-content-between h-100">
                                    <button class="btn btn-link p-1" (click)="removeItem(i)"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div class="align-self-center">
                            <h5 class="my-0 text-dark text-uppercase font-weight-bold">Total:</h5>
                        </div>
                        <span class="text-muted font-weight-bold align-self-center">{{totals.amount|currency:'ARS'}}</span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="col-12">
            <button class="btn btn-block btn-danger" (click)="submitInvoice()" [disabled]="clientForm.invalid||items.length==0||submitting"><i *ngfIf="!submitting" class="fa-solid fa-receipt"></i> {{!submitting?"Emitir ticket":""}}<span [ngClass]="{'d-none':!submitting}">
            <div class="sk-chase" style="font-size: 1.5em;margin-left: -1.5em;">
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
            </div>
        </span></button>
            <div *ngIf="clientForm.invalid||items.length==0" class="alert alert-warning-dark font-italic" role="alert">
                <p>
                    Datos de cliente incompletos o sin ítems cargados
                </p>
            </div>
            <div *ngIf="submitting||messages.length>0" class="alert alert-light text-dark font-weight-bold p-0" role="alert">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-transparent text-dark" *ngFor="let msg of messages">
                        <span [ngSwitch]="msg.status">
                            <div *ngSwitchDefault class="sk-chase" style="font-size: 1.1em;margin-left: -1em;margin-right: 1em;">
                                <div class="sk-chase-dot"></div>
                                <div class="sk-chase-dot"></div>
                                <div class="sk-chase-dot"></div>
                                <div class="sk-chase-dot"></div>
                                <div class="sk-chase-dot"></div>
                                <div class="sk-chase-dot"></div>
                            </div>
                            <i *ngSwitchCase="true" class="text-success-dark fa-solid fa-check"></i>
                            <i *ngSwitchCase="false" class="text-danger-dark fa-solid fa-exclamation"></i>
                        </span> {{msg.p}}
                        <span [ngSwitch]="msg.extra">
                            <a *ngSwitchCase="'PRINT'" href="javascript:void(0)" class="alert-link" (click)="retry('PRINT')">Reintentar</a>
                            <a *ngSwitchCase="'QR'" href="javascript:void(0)" class="alert-link" (click)="retry('QR')">Reintentar</a>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
</div>