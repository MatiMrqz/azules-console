<div class="container-md">
    <div class="row justify-content-center mx-0">
        <div class="col">
            <div class=" card mt-5">
                <div class="px-4 card-header d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-list-check fa-3x"></i>
                        <div class="ml-3">
                            <p class=" display-4 text-uppercase">Cierre de turno</p>
                            <p class="h4 mb-1 font-weight-light">Pepito</p>
                        </div>
                    </div>
                    <div class="h3 mb-1 text-muted font-italic font-weight-lighter">Turno Tarde</div>
                </div>
                <div class="card-body">
                    <ngb-accordion [closeOthers]="true" activeIds="">
                        <ngb-panel id="pumps">
                            <ng-template ngbPanelTitle>
                                <div *ngIf="!isLoading" class="d-flex align-items-center">
                                    <div>
                                        <i class="fa-2x"
                                            [ngClass]="{'fa-square fa-regular':refreshDonePumps()!=pumps.length,'fa-square-check fa-solid text-muted':refreshDonePumps()==pumps.length}"></i>
                                    </div>
                                    <div class="mx-3">
                                        <p class="text-dark title"
                                            [ngClass]="{'text-through text-muted':refreshDonePumps()==pumps.length}">
                                            Surtidores</p>
                                        <p class=" text-muted">
                                            {{refreshDonePumps()}}/{{isLoading?'-':pumps.length}}
                                        </p>
                                    </div>
                                    <div class="mx-5">
                                        <p class="text-muted m-0" style="font-size: larger;">
                                            {{pumpTotalAmount()|currency}}</p>
                                    </div>
                                </div>
                            </ng-template>
                            <ng-template ngbPanelContent>
                                <div class="table-responsive">
                                    <table class=" table table-fix-head" id="">
                                        <thead class="thead-dark text-primary">
                                            <tr>
                                                <th class="text-center">#</th>
                                                <th class="d-none d-lg-table-cell">Tipo</th>
                                                <th class="d-none d-lg-table-cell">Descripcion</th>
                                                <th class="text-center">Lectura Inicial</th>
                                                <th class="text-center">Lectura Final</th>
                                                <th class="text-center">Venteo</th>
                                                <th class="text-center">Vendido</th>
                                                <th class="d-none d-lg-table-cell text-center">Precio Unitario</th>
                                                <th class=" text-center">Importe</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody *ngIf="!isLoading">
                                            <tr *ngFor="let item of pumps"
                                                [ngClass]="{'table-danger':item.validated===false,'table-success':item.validated===true}">
                                                <td class="text-center">{{item.id}}
                                                </td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    {{getTypebyId(item.type_id).name}}</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    {{!item.description?'-':item.description}}</td>
                                                <td class=" text-center">
                                                    {{item.meter}}<small>[{{!item.type_id?'-':getTypebyId(item.type_id).unit}}]</small>
                                                </td>
                                                <td>
                                                    <input [(ngModel)]="item.meter_end" inputmode="numeric"
                                                        type="number" min="0" class="form-control"
                                                        (input)="item.meter_diff=(+item.meter_end-item.meter-item.venting);item.validated=(item.meter_end!=null&&item.venting!=null&&item.meter_diff>=0)">
                                                </td>
                                                <td>
                                                    <input [(ngModel)]="item.venting" inputmode="numeric" type="number"
                                                        min="0" class="form-control"
                                                        (input)="item.meter_diff=(+item.meter_end-item.meter-item.venting);item.validated=(item.meter_end!=null&&item.venting!=null&&item.meter_diff>=0)">
                                                </td>
                                                <td class="text-center">
                                                    <strong>{{item.meter_diff}}</strong><small>[{{!item.type_id?'-':getTypebyId(item.type_id).unit}}]</small>
                                                </td>

                                                <td class="d-none d-lg-table-cell text-center">
                                                    {{item.unit_price|currency}}
                                                </td>
                                                <td class=" text-center">{{(item.unit_price*item.meter_diff)|currency}}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </ng-template>
                        </ngb-panel>
                        <ngb-panel id="gral_meter">
                            <ng-template ngbPanelTitle>
                                <div *ngIf="!isLoading" class="d-flex align-items-center">
                                    <div>
                                        <i class="fa-2x"
                                            [ngClass]="{'fa-square fa-regular':!gralMeter.validated,'fa-square-check fa-solid text-muted':gralMeter.validated===true}"></i>
                                    </div>
                                    <div class="mx-3">
                                        <p class="text-dark title"
                                            [ngClass]="{'text-through text-muted':gralMeter.validated===true}">
                                            Medidor General</p>
                                        <p class=" text-muted">
                                            {{gralMeter.validated?1:0}}/1
                                        </p>
                                    </div>
                                </div>
                            </ng-template>
                            <ng-template ngbPanelContent>
                                <div class="table-responsive">
                                    <table class=" table table-fix-head" id="">
                                        <thead class="thead-dark text-primary">
                                            <tr>
                                                <th class="text-center">#</th>
                                                <th class="d-none d-lg-table-cell">Descripcion</th>
                                                <th class="text-center">Lectura Inicial</th>
                                                <th class="text-center">Lectura Final</th>
                                                <th class="text-center">Consumido</th>
                                            </tr>
                                        </thead>
                                        <tbody *ngIf="!isLoading">
                                            <tr
                                                [ngClass]="{'table-danger':gralMeter.validated===false,'table-success':gralMeter.validated===true}">
                                                <td>GRAL</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell">Medidor General</td>
                                                <td class="text-center">{{gralMeter.accumulated}}</td>
                                                <td><input [(ngModel)]="gralMeter.meter_end" inputmode="numeric"
                                                        type="number" min="0" class="form-control"
                                                        (input)="gralMeter.meter_diff=(+gralMeter.meter_end-gralMeter.accumulated);gralMeter.validated=(gralMeter.meter_end!=null&&gralMeter.meter_diff>=0)">
                                                </td>
                                                <td class="text-center">{{gralMeter.meter_diff}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </ng-template>
                        </ngb-panel>
                        <ngb-panel id="products">
                            <ng-template ngbPanelTitle>
                                <div *ngIf="!isLoading" class="d-flex align-items-center">
                                    <div>
                                        <i class="fa-2x"
                                            [ngClass]="{'fa-square fa-regular':refreshDoneProducts()!=(products|validProducts).length,'fa-square-check fa-solid text-muted':refreshDoneProducts()==(products|validProducts).length}"></i>
                                    </div>
                                    <div class="mx-3">
                                        <p class="text-dark title"
                                            [ngClass]="{'text-through text-muted':refreshDoneProducts()==(products|validProducts).length}">
                                            Productos</p>
                                        <p class=" text-muted">
                                            {{refreshDoneProducts()}}/{{isLoading?'-':(products|validProducts).length}}
                                        </p>
                                    </div>
                                    <div class="mx-5">
                                        <p class="text-muted m-0" style="font-size: larger;">
                                            {{productTotalAmount()|currency}}</p>
                                    </div>
                                </div>
                            </ng-template>
                            <ng-template ngbPanelContent>
                                <div class="table-responsive">
                                    <table class=" table table-fix-head" id="">
                                        <thead class="thead-dark text-primary">
                                            <tr>
                                                <th>Nombre</th>
                                                <th class="d-none d-lg-table-cell">Descripcion</th>
                                                <th class="d-none d-lg-table-cell">Categoría</th>
                                                <th class="text-center">Stock inicial</th>
                                                <th class="text-center">Vendidos</th>
                                                <th class="text-center">Repuestos</th>
                                                <th class="text-center">Stock Final</th>
                                                <th class="d-none d-lg-table-cell text-center">Precio Unitario</th>
                                                <th class=" text-center">Importe</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody *ngIf="!isLoading">
                                            <tr *ngFor="let item of products|validProducts"
                                                [ngClass]="{'table-danger':item.validated===false,'table-success':item.validated===true}">
                                                <td class="cell-ellipsis" style="--mw:90px;">{{item.name}}
                                                </td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    {{!item.description?'-':item.description}}</td>
                                                <td class="d-none d-lg-table-cell">{{!item.category_id?'-':getCategorybyId(item.category_id).name}}
                                                </td>
                                                <td class=" text-center">{{item.stock}}</td>
                                                <td>
                                                    <input [(ngModel)]="item.items_sold" inputmode="numeric"
                                                        type="number" min="0" class="form-control"
                                                        (input)="item.validated=item.stock-item.items_sold+item.items_replacement==item.end_stock"
                                                        [disabled]="item.stock==0">
                                                </td>
                                                <td>
                                                    <input [(ngModel)]="item.items_replacement" inputmode="numeric"
                                                        type="number" min="0" class="form-control"
                                                        (input)="item.validated=item.stock-item.items_sold+item.items_replacement==item.end_stock">
                                                </td>
                                                <td>
                                                    <input [(ngModel)]="item.end_stock" inputmode="numeric"
                                                        type="number" min="0" class="form-control"
                                                        (input)="item.validated=item.stock-item.items_sold+item.items_replacement==item.end_stock">
                                                </td>
                                                <td class="d-none d-lg-table-cell text-center">
                                                    {{item.unit_price|currency}}
                                                </td>
                                                <td class=" text-center">{{(item.unit_price*item.items_sold)|currency}}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </ng-template>
                        </ngb-panel>
                        <ngb-panel id="accounts">
                            <ng-template ngbPanelTitle>
                                <div *ngIf="!isLoading" class="d-flex align-items-center">
                                    <div>
                                        <i class="fa-2x"
                                            [ngClass]="{'fa-square fa-regular':accDoneUpdate()!=8,'fa-square-check fa-solid text-muted':accDoneUpdate()==8}"></i>
                                    </div>
                                    <div class="mx-3">
                                        <p class="text-dark title"
                                            [ngClass]="{'text-through text-muted':accDoneUpdate()==8}">
                                            Rendición</p>
                                        <p class=" text-muted">
                                            {{accDoneUpdate()}}/8
                                        </p>
                                    </div>
                                    <div class="mx-5">
                                        <p class="text-muted m-0" style="font-size: larger;">
                                            {{accTotalAmount()|currency}}</p>
                                    </div>
                                </div>
                            </ng-template>
                            <ng-template ngbPanelContent>
                                <div class="table-responsive">
                                    <table class=" table table-fix-head" id="">
                                        <thead class="thead-dark text-primary">
                                            <tr>
                                                <th>Tipo</th>
                                                <th class="d-none d-lg-table-cell">Descripcion</th>
                                                <th>Monto</th>
                                            </tr>
                                        </thead>
                                        <tbody *ngIf="!isLoading">
                                            <tr
                                                [ngClass]="{'table-danger':(acc.n_envelopes_v&&acc.envelopes_cash_v)===false,'table-success':(acc.n_envelopes_v&&acc.envelopes_cash_v)===true}">
                                                <td>Sobres</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">Nº
                                                    de
                                                    sobres/Total entregado</td>
                                                <td>
                                                    <div class="input-group">
                                                        <input [(ngModel)]="acc.n_envelopes" inputmode="numeric"
                                                            type="number" min="0" class="form-control"
                                                            (input)="acc.n_envelopes_v=acc.n_envelopes>=0"
                                                            placeholder="Sobres">
                                                        <input [(ngModel)]="acc.envelopes_cash" inputmode="numeric"
                                                            type="number" min="0" class="form-control"
                                                            (input)="acc.envelopes_cash_v=acc.envelopes_cash>=0"
                                                            placeholder="$">
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr
                                                [ngClass]="{'table-danger':acc.cash_v===false,'table-success':acc.cash_v===true}">
                                                <td>Efectivo</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    Dinero
                                                    en
                                                    efectivo</td>
                                                <td><input [(ngModel)]="acc.cash" inputmode="numeric" type="number"
                                                        min="0" class="form-control" (input)="acc.cash_v=acc.cash>=0">
                                                </td>
                                            </tr>
                                            <tr
                                                [ngClass]="{'table-danger':acc.vouchers_v===false,'table-success':acc.vouchers_v===true}">
                                                <td>Vales</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    Vales
                                                    entregados</td>
                                                <td><input [(ngModel)]="acc.vouchers" inputmode="numeric" type="number"
                                                        min="0" class="form-control"
                                                        (input)="acc.vouchers_v=acc.vouchers>=0">
                                                </td>
                                            </tr>
                                            <tr
                                                [ngClass]="{'table-danger':acc.cards_v===false,'table-success':acc.cards_v===true}">
                                                <td>Tarjetas</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    Crédito/Débito</td>
                                                <td><input [(ngModel)]="acc.cards" inputmode="numeric" type="number"
                                                        min="0" class="form-control" (input)="acc.cards_v=acc.cards>=0">
                                                </td>
                                            </tr>
                                            <tr
                                                [ngClass]="{'table-danger':acc.expenses_v===false,'table-success':acc.expenses_v===true}">
                                                <td>Gastos</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    Retiros
                                                </td>
                                                <td><input [(ngModel)]="acc.expenses" inputmode="numeric" type="number"
                                                        min="0" class="form-control"
                                                        (input)="acc.expenses_v=acc.expenses>=0">
                                                </td>
                                            </tr>
                                            <tr
                                                [ngClass]="{'table-danger':acc.MercadoPago_v===false,'table-success':acc.MercadoPago_v===true}">
                                                <td>MPago</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    MercadoPago
                                                </td>
                                                <td><input [(ngModel)]="acc.MercadoPago" inputmode="numeric"
                                                        type="number" min="0" class="form-control"
                                                        (input)="acc.MercadoPago_v=acc.MercadoPago>=0">
                                                </td>
                                            </tr>
                                            <tr
                                                [ngClass]="{'table-danger':acc.others_v===false,'table-success':acc.others_v===true}">
                                                <td>Otros</td>
                                                <td class="cell-ellipsis d-none d-lg-table-cell" style="--mw:150px;">
                                                    Ingreso
                                                </td>
                                                <td><input [(ngModel)]="acc.others" inputmode="numeric" type="number"
                                                        min="0" class="form-control"
                                                        (input)="acc.others_v=acc.others>=0">
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </ng-template>
                        </ngb-panel>
                    </ngb-accordion>
                </div>
                <div *ngIf="!isLoading; else spinnerBlock" class="py-3 px-4">
                    <p class="font-weight-light">Progreso:</p>
                    <p>
                        <ngb-progressbar type="light" textType="dark"
                            [value]="(refreshDoneProducts()+refreshDonePumps()+(gralMeter.validated?1:0)+accDoneUpdate())*100/((products|validProducts).length+pumps.length+1+8)"
                            [showValue]="true" height="2em">
                        </ngb-progressbar>
                    </p>
                </div>
                <div class="align-items-center p-4">
                    <p class="display-4 text-uppercase">Resultado del turno</p>
                    <table class="px-4" style="width: 100%;">
                        <thead>
                            <tr class="text-muted" style="font-size: 1.5em;">
                                <th class="text-center font-weight-light">Rendición</th>
                                <th></th>
                                <th class="text-center font-weight-light">Ventas</th>
                                <th></th>
                                <th class="text-center font-weight-light">Diferencia <span
                                        class="text-success">S</span>/<span class="text-danger">F</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="text-light" style="font-size: 2.5em;">
                                <td class="text-center px-1 font-weight-light">{{accTotalAmount()|currency}}</td>
                                <td class="text-center px-1 font-weight-bold">-</td>
                                <td class="text-center px-1 font-weight-light">
                                    {{productTotalAmount()+pumpTotalAmount()|currency}}</td>
                                <td class="text-center px-1 font-weight-bold">=</td>
                                <td [ngClass]="{'text-success':accTotalAmount()-(productTotalAmount()+pumpTotalAmount())>0,'text-danger':accTotalAmount()-(productTotalAmount()+pumpTotalAmount())<0}"
                                    class="text-center px-1 font-weight-bold">
                                    {{accTotalAmount()-(productTotalAmount()+pumpTotalAmount())|currency}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="align-items-center px-4">
                    <!-- <p class="display-4 text-uppercase">Titulo</p> -->
                    <div class="form-group px-3">
                        <label class="font-weight-light" style="font-size: 1em;" for="obs">Observaciones:</label>
                        <textarea #observation id="obs" style="min-height: 7.8em;" class="form-control"
                            placeholder="**Opcional&#10;Ej:Error en stock de producto, diferencias de precio mal actualizado, error de sistema, etc"></textarea>
                    </div>
                </div>
                <div *ngIf="!isLoading" class="align-items-center justify-content-center d-flex px-4">
                    <form>
                        <div style="position: relative !important;" class="input-group input-group-lg col-xl-4 col-lg-6 col-md-7 col-11">
                            <div class="input-group-prepend">
                                <span [ngClass]="{'border-warning':saveButt.disabled}" class="input-group-text" id="pininp">Pin de Pepito</span>
                            </div>
                            <input [ngClass]="{'is-invalid':saveButt.disabled}" #employeePass type="password" class="form-control text-center" placeholder="****" (input)="saveDisabled(employeePass.value)" required>
                            <div class="invalid-tooltip">
                                {{saveDisabled('asdf')?'Planilla incompleta':'Ingrese pin'}}
                              </div>
                            <button #saveButt type="button" class="btn btn-lg text-dark btn-warning" (click)="storeClosingShift(observation.value,employeePass.value)"
                            [disabled]="saveDisabled(employeePass.value)"
                                >Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #spinnerBlock>
    <div class="row py-5">
        <div class="col d-flex align-items-center justify-content-center">
            <div class="sk-chase" style="font-size: 5em;">
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
            </div>
        </div>
    </div>
</ng-template>