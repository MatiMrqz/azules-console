<div class="container-md">
    <div class="row justify-content-center mx-0">
        <div class="col-md-11 col-xl-10">
            <div *ngIf="operationDetail!=undefined;else spinnerBlock" class=" card mt-5">
                <div class="display-3 text-center bg-warning rounded-top text-dark">Editando
                    #{{operationDetail.operation.id}}</div>
                <div class="px-4 card-header d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-list-check fa-4x"></i>
                        <div class="ml-3">
                            <p *ngIf="operationDetail.operation.operation_type=='CLOSE'"
                                class=" display-4 text-uppercase">Cierre de turno</p>
                            <p *ngIf="operationDetail.operation.operation_type=='OPEN'"
                                class=" display-4 text-uppercase">Apertura de turno</p>
                            <p class="h4 mb-1 font-weight-light">{{operationDetail.operation.uname}}</p>
                            <p *ngIf="operationDetail.operation.helper_uname!=null"
                                class="h5 mb-1 font-italic font-weight-light">{{operationDetail.operation.helper_uname}}
                                <strong>(Ayudante)</strong></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="h3 mb-1 text-muted font-italic font-weight-lighter">Turno
                            {{operationDetail.operation.turn_name}}
                        </div>
                        <div class="h5 mb-1 text-muted font-italic font-weight-lighter">
                            {{operationDetail.operation.timestamp|date:'E d/MM/YYYY, HH:mm'}}hs</div>
                        <div class="h5 mb-1 text-muted">Planilla Nº{{operationDetail.operation.id}}</div>
                    </div>
                </div>
                <div class="card-body">
                    <div ngbAccordion [closeOthers]="true" activeIds="">
                        <div ngbAccordionItem id="products">
                            <div ngbAccordionHeader>
                                <button ngbAccordionButton>
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <i class="fa-2x"
                                                [ngClass]="{'fa-square fa-regular':tempData.products.done!=(products).length,'fa-square-check fa-solid text-muted':tempData.products.done==(products).length}"></i>
                                        </div>
                                        <div class="mx-3">
                                            <p class="text-dark title"
                                                [ngClass]="{'text-through text-muted':tempData.products.done==(products).length}">
                                                Productos</p>
                                            <p class=" text-muted">
                                                {{tempData.products.done}}/{{(products).length}}
                                            </p>
                                        </div>
                                        <div class="mx-5">
                                            <p class="text-muted m-0" style="font-size: larger;">
                                                {{tempData.products.accumulated|currency:'ARS'}}</p>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <div ngbAccordionCollapse>
                                <div ngbAccordionBody>
                                    <ng-template>
                                        <div class="table-responsive">
                                            <table class=" table table-fix-head nw-table" id="">
                                                <thead class="thead-dark text-primary">
                                                    <tr>
                                                        <th class="col-4">Nombre</th>
                                                        <th class="col-1 text-center">Stock inicial</th>
                                                        <th class="col-1 text-center">Vendidos</th>
                                                        <th class="col-1 text-center">Recarga</th>
                                                        <th class="col-1 text-center">Stock Final</th>
                                                        <th class="col-2 d-none d-lg-table-cell text-center">Precio
                                                            Unitario</th>
                                                        <th class="col-2 text-center">Importe</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let item of products"
                                                        [ngClass]="{'table-danger':item.validated===false,'table-success':item.validated===true}">
                                                        <td [ngClass]="{'scrolling-text':innerItem.offsetWidth>outerItem.clientWidth}"
                                                            class="set-max-width" style="--mw:200px" #outerItem> <span
                                                                #innerItem>{{item.name}}</span>
                                                        </td>
                                                        <td class=" text-center">
                                                            <input [(ngModel)]="item.init_stock" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="calcProd(item)">
                                                        </td>
                                                        <td>
                                                            <input [(ngModel)]="item.items_sold" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="calcProd(item)">
                                                        </td>
                                                        <td>
                                                            <input [(ngModel)]="item.items_replacement"
                                                                inputmode="numeric" type="number" min="0"
                                                                class="form-control" (input)="calcProd(item)">
                                                        </td>
                                                        <td class="text-center">
                                                            {{item.end_stock}}
                                                        </td>
                                                        <td class="d-none d-lg-table-cell text-center">
                                                            <input [(ngModel)]="item.unit_price" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="calcProd(item)">
                                                        </td>
                                                        <td class=" text-center">
                                                            {{(item.amount_sold)|currency:'ARS'}}
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-template>
                                </div>
                            </div>
                        </div>
                        <div ngbAccordionItem id="accounts">
                            <div ngbAccordionHeader>
                                <button ngbAccordionButton>
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <i class="fa-2x"
                                                [ngClass]="{'fa-square fa-regular':tempData.acc.done!=8,'fa-square-check fa-solid text-muted':tempData.acc.done==8}"></i>
                                        </div>
                                        <div class="mx-3">
                                            <p class="text-dark title"
                                                [ngClass]="{'text-through text-muted':tempData.acc.done==8}">
                                                Rendición</p>
                                            <p class=" text-muted">
                                                {{tempData.acc.done}}/8
                                            </p>
                                        </div>
                                        <div class="mx-5">
                                            <p class="text-muted m-0" style="font-size: larger;">
                                                {{tempData.acc.accumulated|currency:'ARS'}}</p>
                                        </div>
                                    </div>
                                </button>
                            </div>
                            <div ngbAccordionCollapse>
                                <div ngbAccordionBody>
                                    <ng-template>
                                        <div class="table-responsive">
                                            <table class=" table table-fix-head" id="">
                                                <thead class="thead-dark text-primary">
                                                    <tr>
                                                        <th>Tipo</th>
                                                        <th class="d-none d-lg-table-cell">Descripcion</th>
                                                        <th>Monto</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr
                                                        [ngClass]="{'table-danger':(acc.n_envelopes_v&&acc.envelopes_cash_v)===false,'table-success':(acc.n_envelopes_v&&acc.envelopes_cash_v)===true}">
                                                        <td>Sobres</td>
                                                        <td class="cell-ellipsis d-none d-lg-table-cell"
                                                            style="--mw:150px;">Nº de sobres/Total entregado</td>
                                                        <td>
                                                            <div class="row justify-content-center">
                                                                <input [(ngModel)]="acc.n_envelopes" inputmode="numeric"
                                                                    type="number" min="0" class="form-control col-3"
                                                                    (input)="acc.n_envelopes_v=acc.n_envelopes>=0 && acc.n_envelopes!=null;accDoneUpdate()"
                                                                    placeholder="NºSobres">
                                                                <input [(ngModel)]="acc.envelopes_cash"
                                                                    inputmode="numeric" type="number" min="0"
                                                                    class="form-control col-8"
                                                                    (input)="acc.envelopes_cash_v=acc.envelopes_cash>=0 && acc.envelopes_cash!=null;accDoneUpdate()"
                                                                    placeholder="$">
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr
                                                        [ngClass]="{'table-danger':acc.cash_v===false,'table-success':acc.cash_v===true}">
                                                        <td>Efectivo</td>
                                                        <td class="cell-ellipsis d-none d-lg-table-cell"
                                                            style="--mw:150px;">
                                                            Dinero en efectivo
                                                        </td>
                                                        <td><input [(ngModel)]="acc.cash" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="acc.cash_v=acc.cash>=0 && acc.cash!=null;accDoneUpdate()">
                                                        </td>
                                                    </tr>
                                                    <tr
                                                        [ngClass]="{'table-danger':acc.vouchers_v===false,'table-success':acc.vouchers_v===true}">
                                                        <td>Vales</td>
                                                        <td class="cell-ellipsis d-none d-lg-table-cell"
                                                            style="--mw:150px;">
                                                            Vales entregados
                                                        </td>
                                                        <td><input [(ngModel)]="acc.vouchers" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="acc.vouchers_v=acc.vouchers>=0 && acc.vouchers!=null;accDoneUpdate()">
                                                        </td>
                                                    </tr>
                                                    <tr
                                                        [ngClass]="{'table-danger':acc.cards_v===false,'table-success':acc.cards_v===true}">
                                                        <td>Tarjetas</td>
                                                        <td class="cell-ellipsis d-none d-lg-table-cell"
                                                            style="--mw:150px;">
                                                            Crédito/Débito</td>
                                                        <td><input [(ngModel)]="acc.cards" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="acc.cards_v=acc.cards>=0 && acc.cards!=null;accDoneUpdate()">
                                                        </td>
                                                    </tr>
                                                    <tr
                                                        [ngClass]="{'table-danger':acc.expenses_v===false,'table-success':acc.expenses_v===true}">
                                                        <td>Gastos</td>
                                                        <td class="cell-ellipsis d-none d-lg-table-cell"
                                                            style="--mw:150px;">
                                                            Retiros
                                                        </td>
                                                        <td><input [(ngModel)]="acc.expenses" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="acc.expenses_v=acc.expenses>=0 && acc.expenses!=null;accDoneUpdate()">
                                                        </td>
                                                    </tr>
                                                    <tr
                                                        [ngClass]="{'table-danger':acc.MercadoPago_v===false,'table-success':acc.MercadoPago_v===true}">
                                                        <td>MPago</td>
                                                        <td class="cell-ellipsis d-none d-lg-table-cell"
                                                            style="--mw:150px;">
                                                            MercadoPago
                                                        </td>
                                                        <td><input [(ngModel)]="acc.MercadoPago" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="acc.MercadoPago_v=acc.MercadoPago>=0 && acc.MercadoPago!=null;accDoneUpdate()">
                                                        </td>
                                                    </tr>
                                                    <tr
                                                        [ngClass]="{'table-danger':acc.others_v===false,'table-success':acc.others_v===true}">
                                                        <td>Otros</td>
                                                        <td class="cell-ellipsis d-none d-lg-table-cell"
                                                            style="--mw:150px;">
                                                            Ingreso
                                                        </td>
                                                        <td><input [(ngModel)]="acc.others" inputmode="numeric"
                                                                type="number" min="0" class="form-control"
                                                                (input)="acc.others_v=acc.others>=0 && acc.others!=null;accDoneUpdate()">
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <p class="display-4 text-uppercase text-center text-md-left">Resultado del turno</p>
                    <div *ngIf="!isLoading" class="mt-3 row align-items-center justify-content-center text-center"
                        style="font-size: 1.5em;">
                        <div class="col-xl-3 col-md-5 flex-column ">
                            <p class="font-weight-light text-muted mb-0">Rendición</p>
                            <p class="font-weight-light" style="font-size: 1.7em;">
                                {{tempData.acc.accumulated|currency:'ARS'}}</p>
                        </div>

                        <div class="col-xl-1 col-md-2">
                            <p class="font-weight-bold" style="font-size: 1.7em;">-</p>
                        </div>
                        <div class="col-xl-3 col-md-5 flex-column">
                            <p class="font-weight-light text-muted mb-0">Ventas</p>
                            <p class="font-weight-light" style="font-size: 1.7em;">
                                {{tempData.products.accumulated+tempData.posop.accumulated|currency:'ARS'}}</p>
                        </div>

                        <div class="col-md-1">
                            <p class="font-weight-bold" style="font-size: 1.7em;">=</p>
                        </div>
                        <div class="col-xl-3 col-md-5 flex-column">
                            <p class="font-weight-light text-muted mb-0">Diferencia <span
                                    class="text-success">S</span>/<span class="text-danger">F</span></p>
                            <p class="font-weight-bold"
                                [ngClass]="{'text-success':tempData.acc.accumulated-(tempData.posop.accumulated+tempData.products.accumulated)>0,'text-danger':tempData.acc.accumulated-(tempData.posop.accumulated+tempData.products.accumulated)<0}"
                                style="font-size: 1.7em;">
                                {{tempData.acc.accumulated-(tempData.products.accumulated+tempData.posop.accumulated)|currency:'ARS'}}
                            </p>
                        </div>
                    </div>
                </div>
                <div *ngIf="!isLoading" class="align-items-center justify-content-center d-flex px-4">
                    <form #f="ngForm" class="col-8" (submit)="saveOperation(f.value)">
                        <div class="form-group px-3">
                            <label class="text-secondary" style="font-size: 1.2em;" for="obs">Motivo:</label>
                            <textarea [ngClass]="{'is-invalid':observation.invalid}" name="observation"
                                #observation="ngModel" id="obs" style="min-height: 7.8em;" class="form-control" ngModel
                                required></textarea>
                            <div class="invalid-tooltip">
                                Requerido
                            </div>
                        </div>
                        <div class="input-group input-group-lg">
                            <div class="input-group-prepend">
                                <span style="position: relative !important;top: 0px !important;left: 0px !important;"
                                    [ngClass]="{'border-warning':f.invalid}" class="input-group-text"
                                    id="pininp">Contraseña:</span>
                            </div>
                            <input [ngClass]="{'is-invalid':adminPass.invalid}" #adminPass="ngModel" name="adminPass"
                                class="form-control text-center" type="password" ngModel required>
                            <div class="invalid-tooltip">
                                {{f.value.valid?'Planilla incompleta':'Ingrese pin'}}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-lg btn-block text-dark btn-warning mb-2"
                            [disabled]="(tempData.products.done!=(products).length||tempData.posop.done!=(posop).length||tempData.acc.done!=8)||f.invalid||saving">
                            <span [ngClass]="{'d-none':!saving}">
                                <div class="sk-chase" style="font-size: 1.5em;margin-left: -1.5em;">
                                    <div class="sk-chase-dot"></div>
                                    <div class="sk-chase-dot"></div>
                                    <div class="sk-chase-dot"></div>
                                    <div class="sk-chase-dot"></div>
                                    <div class="sk-chase-dot"></div>
                                    <div class="sk-chase-dot"></div>
                                </div>
                            </span>{{saving?null:'Guardar y cerrar turno'}}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



<ng-template #spinnerBlock>
    <div class="row py-5">
        <div class="col d-flex align-items-center justify-content-center">
            <div class="sk-chase" style="font-size: 5em;">
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
            </div>
        </div>
    </div>
</ng-template>